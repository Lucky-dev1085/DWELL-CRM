#!/bin/bash
source /home/ubuntu/crm/venv/bin/activate
cd /home/ubuntu/crm

if [ "$DEPLOYMENT_GROUP_NAME" == "CRM-Dev-deployment-group" ] || [ "$DEPLOYMENT_GROUP_NAME" == "CRM-UP-QA-deployment-group" ]
then
  docker-compose up -d
else
  echo yes | DJANGO_SETTINGS_MODULE=backend.settings.production python manage.py collectstatic
  /home/ubuntu/aws/install

  declare -a arr=("POSTGRES_PASSWORD" "POSTGRES_USER" "POSTGRES_HOST" "POSTGRES_DB" "DJANGO_SETTINGS_MODULE" "REDIS_URL"
  "SENTRY_KEY" "SENTRY_PROJECT" "FLOWER_BASIC_AUTH" "MST_HOST" "CRM_HOST" "AWS_ACCESS_KEY_ID" "AWS_SECRET_ACCESS_KEY" "NYLAS_OAUTH_CLIENT_ID"
  "NYLAS_OAUTH_CLIENT_SECRET" "NYLAS_SYNC_DAYS_LIMIT" "NYLAS_SYNC_STEPS"
  "PUSHER_APP_ID" "PUSHER_KEY" "PUSHER_SECRET" "PUSHER_CLUSTER" "FE_SENTRY_KEY" "FE_SENTRY_PROJECT" "SINGLE_BEAT_REDIS_SERVER"
  "TWILIO_ACCOUNT_SID" "TWILIO_AUTH_TOKEN" "TWIML_APPLICATION_SID" "CHAT_BOT_HOST" "REAL_PAGE_API_USERNAME"
  "REAL_PAGE_API_PASSWORD" "REAL_PAGE_API_LICENSE_KEY" "RESMAN_INTEGRATION_PARTNER_ID" "RESMAN_API_KEY"
  "SMART_RENT_EMAIL" "SMART_RENT_PASSWORD" "ON_SITE_USERNAME" "ON_SITE_PASSWORD" "YARDI_TOKEN" "TWILIO_STUDIO_ID"
  "RASA_X_DB_NAME" "RASA_X_DB_HOST" "RASA_X_DB_USER" "RASA_X_DB_PASSWORD" "HF_USERNAME" "HF_PASSWORD" "HF_CONVERSATION_SOURCE"
  "RASA_TOKEN" "RASA_WORKER_HOST" "RABBIT_URL" "DEMO_TOUR_NYLAS_ACCESS_TOKEN" "DEMO_TOUR_NYLAS_CALENDAR_ID" "MAIN_PAGE_HOST"
  "DWELL_TOUR_PARTICIPANT_EMAIL" "HOBBES_AUTO_TEST_REPORT_EMAIL")

  for i in "${arr[@]}"
  do
     ARG=$i
     echo $ARG
     NAME="$(echo ${CRM_ENV}_${ARG})"
     VALUE=`echo $(aws2 ssm get-parameter --name $NAME --with-decryption  --query Parameter.Value) | sed -e 's/^"//' -e 's/"$//'`
     printf -v $ARG $VALUE
  done

  PYTHONPATH=/home/ubuntu/crm \
    POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
    POSTGRES_USER=$POSTGRES_USER \
    POSTGRES_HOST=$POSTGRES_HOST \
    POSTGRES_DB=$POSTGRES_DB \
    DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE \
    REDIS_URL=$REDIS_URL \
    SENTRY_KEY=$SENTRY_KEY \
    SENTRY_PROJECT=$SENTRY_PROJECT \
    FE_SENTRY_KEY=$FE_SENTRY_KEY \
    FE_SENTRY_PROJECT=$FE_SENTRY_PROJECT \
    FLOWER_BASIC_AUTH=$FLOWER_BASIC_AUTH \
    MST_HOST=$MST_HOST \
    CRM_HOST=$CRM_HOST \
    AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
    AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
    NYLAS_OAUTH_CLIENT_ID=$NYLAS_OAUTH_CLIENT_ID \
    NYLAS_OAUTH_CLIENT_SECRET=$NYLAS_OAUTH_CLIENT_SECRET \
    NYLAS_SYNC_DAYS_LIMIT=$NYLAS_SYNC_DAYS_LIMIT \
    NYLAS_SYNC_STEPS=$NYLAS_SYNC_STEPS \
    PUSHER_APP_ID=$PUSHER_APP_ID \
    PUSHER_KEY=$PUSHER_KEY \
    PUSHER_SECRET=$PUSHER_SECRET \
    PUSHER_CLUSTER=$PUSHER_CLUSTER \
    SINGLE_BEAT_REDIS_SERVER=$SINGLE_BEAT_REDIS_SERVER \
    TWILIO_ACCOUNT_SID=$TWILIO_ACCOUNT_SID \
    TWILIO_AUTH_TOKEN=$TWILIO_AUTH_TOKEN \
    TWIML_APPLICATION_SID=$TWIML_APPLICATION_SID \
    CHAT_BOT_HOST=$CHAT_BOT_HOST \
    REAL_PAGE_API_USERNAME=$REAL_PAGE_API_USERNAME \
    REAL_PAGE_API_PASSWORD=$REAL_PAGE_API_PASSWORD \
    REAL_PAGE_API_LICENSE_KEY=$REAL_PAGE_API_LICENSE_KEY \
    RESMAN_INTEGRATION_PARTNER_ID=$RESMAN_INTEGRATION_PARTNER_ID \
    RESMAN_API_KEY=$RESMAN_API_KEY \
    SMART_RENT_EMAIL=$SMART_RENT_EMAIL \
    SMART_RENT_PASSWORD=$SMART_RENT_PASSWORD \
    ON_SITE_USERNAME=$ON_SITE_USERNAME \
    ON_SITE_PASSWORD=$ON_SITE_PASSWORD \
    YARDI_TOKEN=$YARDI_TOKEN \
    TWILIO_STUDIO_ID=$TWILIO_STUDIO_ID \
    RASA_X_DB_NAME=$RASA_X_DB_NAME\
    RASA_X_DB_HOST=$RASA_X_DB_HOST\
    RASA_X_DB_USER=$RASA_X_DB_USER\
    RASA_X_DB_PASSWORD=$RASA_X_DB_PASSWORD\
    HF_USERNAME=$HF_USERNAME\
    HF_PASSWORD=$HF_PASSWORD\
    HF_CONVERSATION_SOURCE=$HF_CONVERSATION_SOURCE\
    RASA_TOKEN=$RASA_TOKEN\
    RASA_WORKER_HOST=$RASA_WORKER_HOST\
    RABBIT_URL=$RABBIT_URL\
    DEMO_TOUR_NYLAS_ACCESS_TOKEN=$DEMO_TOUR_NYLAS_ACCESS_TOKEN\
    DEMO_TOUR_NYLAS_CALENDAR_ID=$DEMO_TOUR_NYLAS_CALENDAR_ID\
    MAIN_PAGE_HOST=$MAIN_PAGE_HOST\
    DWELL_TOUR_PARTICIPANT_EMAIL=$DWELL_TOUR_PARTICIPANT_EMAIL\
    HOBBES_AUTO_TEST_REPORT_EMAIL=$HOBBES_AUTO_TEST_REPORT_EMAIL\
    supervisord -c /home/ubuntu/crm/supervisor/default.conf

    cd /home/ubuntu/crm/frontend
    PM2_HOME="/home/ubuntu/.pm2" pm2 start main_page_server.js
fi
